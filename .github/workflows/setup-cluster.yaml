name: Set up GKE cluster Automated Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev

jobs:
  terraform-apply:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
      ZONE: ${{ secrets.GCP_ZONE }}
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
      TF_VAR_cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
      TF_VAR_region: ${{ secrets.GCP_REGION }}
      TF_VAR_zone: ${{ secrets.GCP_ZONE }}
      TF_VAR_node_count: 1
      TF_VAR_machine_type: "e2-medium"
    steps:
      - uses: actions/checkout@v3

      - uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - uses: hashicorp/setup-terraform@v2

      - run: terraform init
        working-directory: terraform/live/${{ github.event.inputs.environment }}

      - run: terraform apply -auto-approve
        working-directory: terraform/live/${{ github.event.inputs.environment }}


  ingress-controller:
    runs-on: ubuntu-latest
    needs: terraform-apply
    environment: ${{ github.event.inputs.environment }}
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
      ZONE: ${{ secrets.GCP_ZONE }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: azure/setup-kubectl@v3
      - uses: azure/setup-helm@v3

      - name: Add Google Cloud SDK distribution URI as apt source
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get install -y apt-transport-https ca-certificates
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update

      - name: Install gke-gcloud-auth-plugin
        run: sudo apt-get install -y google-cloud-cli-gke-gcloud-auth-plugin

      - run: |
          gcloud container clusters get-credentials "$CLUSTER_NAME" \
            --zone "$ZONE" --project "$PROJECT_ID"

      - name: Install NGINX Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.1/deploy/static/provider/cloud/deploy.yaml

      - name: Patch ingress-nginx-controller Service for metrics
        run: |
          kubectl patch service ingress-nginx-controller -n ingress-nginx --type='json' -p='[{"op":"add","path":"/spec/ports/-","value":{"name":"metrics","port":10254,"protocol":"TCP","targetPort":"metrics"}}]'

      - name: Wait for ingress-nginx controller to be ready
        run: |
          kubectl rollout status deployment/ingress-nginx-controller -n ingress-nginx --timeout=120s


  helm-deploy:
    runs-on: ubuntu-latest
    needs: ingress-controller
    environment: ${{ github.event.inputs.environment }}
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
      ZONE: ${{ secrets.GCP_ZONE }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: azure/setup-kubectl@v3
      - uses: azure/setup-helm@v3


      - name: Add Google Cloud SDK distribution URI as apt source
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get install -y apt-transport-https ca-certificates
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update

      - name: Install gke-gcloud-auth-plugin
        run: sudo apt-get install -y google-cloud-cli-gke-gcloud-auth-plugin

      - run: |
          gcloud container clusters get-credentials "$CLUSTER_NAME" \
            --zone "$ZONE" --project "$PROJECT_ID"

      - run: |
          helm repo add podinfo https://stefanprodan.github.io/podinfo
          helm repo update

      - run: |
          helm upgrade --install podinfo podinfo/podinfo \
            --namespace dev \
            --create-namespace \
            --wait \
            -f kubernetes/overlays/dev/values.yaml

      - run: kubectl apply -f kubernetes/base/ingress/ingress.yaml

  observability:
    runs-on: ubuntu-latest
    needs: helm-deploy
    environment: ${{ github.event.inputs.environment }}
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
      ZONE: ${{ secrets.GCP_ZONE }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: azure/setup-kubectl@v3
      - uses: azure/setup-helm@v3

      - run: |
          gcloud container clusters get-credentials "$CLUSTER_NAME" \
            --zone "$ZONE" --project "$PROJECT_ID"

      - run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - run: |
          helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --create-namespace \
            --wait \
            -f observability/grafana/values.yaml

      - run: kubectl apply -f observability/prometheus/podinfo-servicemonitor.yaml
      - run: kubectl apply -f observability/prometheus/podinfo-alerts.yaml
      - run: kubectl apply -f observability/prometheus/ingress-nginx-servicemonitor.yaml

      - run: |
          kubectl create secret generic grafana-basic-auth \
            --from-literal=auth="${{ secrets.GRAFANA_BASIC_AUTH }}" \
            -n monitoring \
            --dry-run=client -o yaml | kubectl apply -f -

      - run: kubectl apply -f kubernetes/base/ingress/grafana-ingress.yaml
